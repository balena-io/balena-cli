---
name: test release
# https://github.com/product-os/flowzone/tree/master/.github/actions
inputs:
  json:
    description: "JSON stringified object containing all the inputs from the calling workflow"
    required: true
  secrets:
    description: "JSON stringified object containing all the secrets from the calling workflow"
    required: true
  variables:
    description: "JSON stringified object containing all the variables from the calling workflow"
    required: true

  # --- custom environment
  NODE_VERSION:
    type: string
    default: '24.x'
  VERBOSE:
    type: string
    default: "true"

runs:
  # https://docs.github.com/en/actions/creating-actions/creating-a-composite-action
  using: "composite"
  steps:
    # https://github.com/actions/setup-node#caching-global-packages-data
    - name: Setup Node.js
      uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6
      with:
        node-version: ${{ inputs.NODE_VERSION }}
        cache: npm

    # TODO: remove once we update the Linux runner to a newer Ubuntu that ships with gcc/g++ 14
    - name: Install gcc & g++ 14
      if: runner.os == 'Linux' && runner.arch == 'ARM64'
      shell: bash
      run: |
        # Install newer build dependencies to workaround a build issue
        # with etcher-sdk's lzma-native failing to build on node24
        sudo apt-get update && sudo apt-get -y install --no-install-recommends gcc-14 g++-14
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-14 60 --slave /usr/bin/g++ g++ /usr/bin/g++-14

    - name: Set up Python 3.11
      if: runner.os == 'macOS'
      uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6
      with:
        python-version: "3.11"

    - name: Test release
      shell: bash
      run: |
        set -ea

        [[ '${{ inputs.VERBOSE }}' =~ on|On|Yes|yes|true|True ]] && set -x

        if [[ -e package-lock.json ]] || [[ -e npm-shrinkwrap.json ]]; then
            npm ci
        else
            npm i
        fi

        npm run build
        npm run test:core
      env:
        REF_NAME: ${{ github.event.pull_request.head.ref }}
        REF_SHA: ${{ github.event.pull_request.head.sha }}
    - name: Compress custom source
      shell: pwsh
      run: tar --exclude-vcs -acf ${{ runner.temp }}/custom.tgz .

    - name: Upload custom artifact
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
      with:
        name: custom-${{ github.event.pull_request.head.sha || github.event.head_commit.id }}-${{ runner.os }}-${{ runner.arch }}
        path: ${{ runner.temp }}/custom.tgz
        retention-days: 1
